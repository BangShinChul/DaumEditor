<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Daum에디터 - 이미지 첨부</title>
<script src="../../js/popup.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="../../css/popup.css" type="text/css"  charset="utf-8"/>
<style type="text/css">
    #drop_zone {
        border: dashed 1px silver;
        padding: 10px;
        height: 50px;
        text-align: center;
        font: 24px 'sans-serif';
        line-height: 50px;
    }

    .thumb {
        height: 75px;
        border: 1px solid #000;
        margin: 10px 5px 0 0;
    }
</style>
</head>
<body onload="initUploader();">
<div class="wrapper">
	<div class="header">
		<h1>사진 첨부</h1>
	</div>
	<div class="body">
		<dl class="alert">
		    <dt>사진 첨부 확인</dt>
		    <dd>
                <div id="drop_zone">Drop files here</div>
                <output id="list"></output>
			</dd>
		</dl>
	</div>
	<div class="footer">
		<p><a href="#" onclick="closeWindow();" title="닫기" class="close">닫기</a></p>
		<ul>
			<li class="submit"><a href="#" onclick="done();" title="등록" class="btnlink">등록</a> </li>
			<li class="cancel"><a href="#" onclick="closeWindow();" title="취소" class="btnlink">취소</a></li>
		</ul>
	</div>
</div>

<script type="text/javascript">
    /*
    references.
        http://www.html5rocks.com/en/tutorials/file/dndfiles/
        http://www.w3.org/TR/file-upload/
        https://developer.mozilla.org/en/Canvas_tutorial/Using_images
     */

    // TODO file api support test

    var imageDatas = [];

    var dropZone = document.getElementById('drop_zone');

    dropZone.addEventListener('dragover', function(e) {
        e.stopPropagation();
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }, false);

    dropZone.addEventListener('drop', function(e) {
        e.stopPropagation();
        e.preventDefault();

        var files = e.dataTransfer.files,
                output = [],
                nonImageFileDetected = false,
                i, file;

        for (i = 0; i < files.length; i++) {
            file = files[i];

            if (!file.type.match('image.*')) {
                nonImageFileDetected = true;
                continue;
            }

            var reader = new FileReader();
            reader.onload = (function(file) {
                return function(e) {
                    var img = document.createElement("img");
                    img.onload = (function (img) {
                        return function() {
                            var width = img.width, height = img.height;
                            var maxWidth = 250, maxHeight = 250;

                            var ratio = 1;
                            if (width > maxWidth) {
                                ratio = maxWidth / width;
                            } else if (height > maxHeight) {
                                ratio = maxHeight / height;
                            }

                            var resizedCanvas = document.createElement('canvas');
                            resizedCanvas.width = width * ratio;
                            resizedCanvas.height = height * ratio;
                            var resizedCtx = resizedCanvas.getContext("2d");
                            resizedCtx.drawImage(img, 0, 0, resizedCanvas.width, resizedCanvas.height);

                            var resizedData = resizedCanvas.toDataURL();

                            var span = document.createElement('span');
                            span.innerHTML = ['<img class="thumb" src="', resizedData,
                                '" title="', file.name, '"/>'].join('');
                            document.getElementById('list').insertBefore(span, null);

                            imageDatas.push({
                                'imageurl': resizedData,
                                'filename': file.name,
                                'filesize': resizedData.length,
                                'imagealign': 'C',
                                'originalurl': resizedData,
                                'thumburl': resizedData
                            });
                        };
                    })(img);
                    img.src = e.target.result;

                };
            })(file);

            // Read in the image file as a data URL.
            reader.readAsDataURL(file);
        }

        if (nonImageFileDetected) {
            alert("allowed image files only");
        }
    }, false);
</script>

<script type="text/javascript">
    function done() {
        if (typeof(execAttach) == 'undefined') { //Virtual Function
            return;
        }

//        var _mockdata = {
//            'imageurl': 'http://cfile284.uf.daum.net/image/116E89154AA4F4E2838948',
//            'filename': 'editor_bi.gif',
//            'filesize': 640,
//            'imagealign': 'C',
//            'originalurl': 'http://cfile284.uf.daum.net/original/116E89154AA4F4E2838948',
//            'thumburl': 'http://cfile284.uf.daum.net/P150x100/116E89154AA4F4E2838948'
//        };
//        execAttach(_mockdata);

        for (var i = 0; i < imageDatas.length; i++) {
            execAttach(imageDatas[i]);
        }
                
        closeWindow();
    }

    function initUploader() {
        var _opener = PopupUtil.getOpener();
        if (!_opener) {
            alert('잘못된 경로로 접근하셨습니다.');
            return;
        }

        var _attacher = getAttacher('image', _opener);
        registerAction(_attacher);
    }
</script>
</body>
</html>