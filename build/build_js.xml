<?xml version="1.0"?>
<project name="trex_build_js">
	<property file="build.properties" />

	<path id="ant.contrib.classpath">
		<fileset dir="./lib/ant-contrib">
			<include name="ant-contrib-1.0b3.jar" />
		</fileset>
	</path>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpathref="ant.contrib.classpath" />


	<!-- editor.js : merge & minify javascript -->
	<target name="merge_javascripts">
		<antcall target="generate_version_js" />
		<antcall target="merge_editor_js" />
		<antcall target="merge_popup_js" />
        <antcall target="copy_etc_js_to_dist" />
	</target>

	<target name="generate_version_js">
        <!--TODO depends로 load_version_properties를 지정하고싶은데 다른 파일에 정의된 target이다. -->
        <ant antfile="build.xml" target="load_version_properties" />
		<echo file="${working.dir}/js/version.js">Editor.version="${editor.version}";</echo>
	</target>

    <target name="clean_previous_js_output">
        <delete dir="${dist.dir}/js" />
    </target>

	<target name="merge_editor_js" depends="clean_previous_js_output">
		<foreach list="${services.list}" param="service_name" target="    _merge_js" />
	</target>


	<target name="    _merge_js">
		<echo message="Merge javascripts for &quot;${service_name}&quot;" />
        <mkdir dir="${dist.dir}/js/_orig" />
		<property name="merged.js.path" value="${dist.dir}/js/_orig/editor_${service_name}.js" />
        <java jar="${lib.rhino.path}" failonerror="true" fork="true">
			<arg value="${build.js.dir}/concatEditorService.js" />
			<arg value="${merged.js.path}" />
			<arg value="${working.dir}" />
			<arg value="${service_name}" />
		</java>
		<echo message="${merged.js.path} created" />
	</target>


	<target name="merge_popup_js">
		<echo message="Merge popup.js ..." />
        <java jar="${lib.rhino.path}" failonerror="true" fork="true">
			<arg value="${build.js.dir}/concatEditor.js" />
			<arg value="${dist.dir}/js/_orig/popup.js" />
			<arg value="${working.dir}" />
			<arg value="popup.js" />
		</java>
	</target>


    <target name="copy_etc_js_to_dist">
		<echo message="copy etc to dist" />
		<copy file="${working.dir}/js/global.js" todir="${dist.dir}/js/_orig" />
		<copy file="${working.dir}/js/editor_loader.js" todir="${dist.dir}/js/_orig" />

		<echo message="copy async tools to _orig" />
        <copy todir="${dist.dir}/js/_orig${async.trex.dir}" overwrite="true">
            <fileset dir="${working.dir}/js${async.trex.dir}" />
        </copy>
        <copy todir="${dist.dir}/js/_orig${async.daumx.dir}" overwrite="true">
            <fileset dir="${working.dir}/js${async.daumx.dir}" />
        </copy>
	</target>

	<target name="escape_and_delete_logging">
		<echo message="Escape orig.editor.js" />
		<native2ascii encoding="utf-8" src="${dist.dir}/js/_orig" dest="${dist.dir}/js/_orig" includes="**/*.js" excludes="**/*.esc.js" ext=".esc.js" />

		<echo message="Delete console message" />
		<replaceregexp match="(console\.[^;]*;)" replace="" flags="g" byline="true" encoding="utf-8">
			<fileset dir="${dist.dir}/js/_orig" includes="**/*.esc.js" />
		</replaceregexp>
		<replaceregexp match="(StopWatch\.lap\([^;]*;)" replace="" flags="g" byline="true" encoding="utf-8">
			<fileset dir="${dist.dir}/js/_orig" includes="**/*.esc.js" />
		</replaceregexp>
	</target>

	<target name="minify_javascripts">
		<foreach target="    _minify_javascript" param="file">
			<path>
				<fileset dir="${dist.dir}/js/_orig" includes="**/*.esc.js" />
			</path>
		</foreach>
	</target>

	<target name="    _minify_javascript">
		<!--suppress AntResolveInspection -->
        <propertyregex property="target_path" input="${file}" regexp="(.*)/_orig/(.*)\.esc\.js" replace="\1/\2.js" />
        <dirname property="target_dir" file="${target_path}" />
        <mkdir dir="${target_dir}" />
		<echo message="minify ${file} to ${target_path}" />
		<java classname="com.yahoo.platform.yui.compressor.YUICompressor" classpath="${lib.yuicompressor.path}" failonerror="true">
			<arg value="--charset" />
			<arg value="utf-8" />
			<arg value="--line-break" />
			<arg value="1000" />
			<!--suppress AntResolveInspection -->
			<arg file="${file}" />
			<arg value="-o" />
			<arg file="${target_path}" />
		</java>
	</target>
</project>
